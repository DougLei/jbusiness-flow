{
	"name":"shoppingDiscount",
	"description":"购物打折流程", 
	"version":"1",
	"state":1,
	
	"params":[{
		"name":"shoppingCarId",
		"description":"购物车id",
		"scope":1,
		"required":true
	}],
	
	"events":[{
		"name":"end",
		"actions":[{ 
			"type":"end"
		}]
	},{
		"name":"queryProductsByShoppingCarId",
		"description":"根据购物车id获取商品集合",
		"actions":[{ 
			"type":"sql_query", 
			"content":{
				"name":"SQL_queryProductsByShoppingCarId",
				"params":[{
					"name":"shoppingCarId",
					"scope":1
				}]
			},
			"result":{
				"name":"products",
				"scope":3,
				"dataType":"list"
			}
		}]
	},{
		"name":"productsNotExists",
		"description":"购物车中没有商品",
		"actions":[{
			"type":"param_op_declare",
			"content":{
				"params":[{
					"name":"productsNotExists",
					"scope":2,
					"value":"购物车中不存在商品"
				}]
			}
		}]
	},{
		"name":"calcProductsTotalPrice",
		"description":"计算商品的总价",
		"actions":[{
			"type":"param_op_declare",
			"content":{
				"params":[{
					"name":"totalPrice",
					"scope":2,
					"dataType":"double"
				}]
			}
		},{ 
			"type":"func_loop",
			"content":{
				"collection":"products",
				"scope":3,
				"alias":"product",
				"actions":[{
					"type":"data_op_arithmetic",
					"content":{
						"arithmetic":[{
							"paramName":"totalPrice",
							"paramScope":2,
							"op":"add"
						},{
							"paramName":"product.PRICE",
							"paramScope":4
						}]
					},
					"result":{
						"name":"totalPrice",
						"scope":2
					}
				}]
			}
		}]
	},{
		"name":"calcXSLProductsTotalPrice",
		"description":"计算商品中洗漱类用品的总价, 如果大于等于50就减去10元",
		"actions":[{
			"type":"param_op_declare",
			"content":{
				"params":[{
					"name":"xslTotalPrice",
					"scope":4,
					"dataType":"double"
				}]
			}
		},{ 
			"type":"func_loop",
			"content":{
				"collection":"products",
				"scope":3,
				"alias":"product",
				"actions":[{
					"type":"func_switch",
					"content":{
						"switch":[{
							"conditionGroups":[{
								"conditions":[{
									"type":"data_op_comp",
									"content":{
										"op":"eq",
										"left":{
											"paramName":"product.TYPE",
											"paramScope":4
										},
										"right":{
											"value":1
										}
									}
								}]
							}],
							"actions":[{
								"type":"data_op_arithmetic",
								"content":{
									"arithmetic":[{
										"paramName":"xslTotalPrice",
										"paramScope":4,
										"op":"add"
									},{
										"paramName":"product.PRICE",
										"paramScope":4
									}]
								},
								"result":{
									"name":"xslTotalPrice",
									"scope":4
								}
							}]
						}]
					}
				}]
			}
		},{
			"type":"func_switch",
			"content":{
				"switch":[{
					"conditionGroups":[{
						"condition":[{
							"type":"data_op_comp",
							"content":{
								"op":"ge",
								"left":{
									"paramName":"xslTotalPrice",
									"paramScope":4
								},
								"right":{
									"value":50
								}
							}
						}]
					}],
					"actions":[{
						"type":"data_op_arithmetic",
						"content":{
							"arithmetic":[{
								"paramName":"totalPrice",
								"paramScope":2,
								"op":"sub"
							},{
								"value":10
							}]
						},
						"result":{
							"name":"totalPrice",
							"scope":2
						}
					}]
				}]
			}
		}]
	}],
	
	"flows":[{ 
		"description":"如果指定购物车id中没有商品",
		"type":2,
		"order":1,
		"sourceEvent":"queryProductsByShoppingCarId",
		"targetEvent":"productsNotExists",	
		"conditionGroups":[{
			"conditions":[{
				"type":"data_op_comp",
				"content":{
					"op":"eq",
					"left":{
						"paramName":"products.size",
						"paramScope":3
					},
					"right":{
						"value":0
					}
				}
			}]
		}]
	},{ 
		"description":"如果指定购物车id中有商品",
		"type":2,
		"order":2,
		"sourceEvent":"queryProductsByShoppingCarId",
		"targetEvent":"calcProductsTotalPrice"
	},{
		"type":1,
		"sourceEvent":"productsNotExists",
		"targetEvent":"end"
	},{
		"type":1,
		"sourceEvent":"calcProductsTotalPrice",
		"targetEvent":"calcXSLProductsTotalPrice"
	},{
		"type":1,
		"sourceEvent":"calcXSLProductsTotalPrice",
		"targetEvent":"end"
	}],
	
	"sqls":[{
		"name":"SQL_queryProductsByShoppingCarId",
		"description":"根据购物车id查询商品集合",
		"content":{
			"tmp":"SELECT ID, TYPE, NAME, PRICE FROM PRODUCT WHERE ID IN (SELECT PRODUCT_ID FROM SHOPPING_CAR WHERE SHOPPING_CAR_ID = ?)"
		},
		"params":[{
			"name":"shoppingCarId",
			"dataType":"string"
		}]
	}]
}